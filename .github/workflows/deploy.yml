name: Deploy to Production

on:
  push:
    branches:
      - publish

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH (git pull)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 30m
          script: |
            cd ~/public_html

            # Backup .env and .htaccess
            echo "ðŸ“¦ Backing up config files..."
            cp .env ~/env_backup 2>/dev/null || true
            cp .htaccess ~/htaccess_backup 2>/dev/null || true
            cp public/.htaccess ~/public_htaccess_backup 2>/dev/null || true

            # Pull latest code from GitHub
            echo "â¬‡ï¸ Pulling latest code..."
            git fetch origin publish
            git reset --hard origin/publish

            # Restore protected files
            echo "ðŸ”„ Restoring config files..."
            cp ~/env_backup .env 2>/dev/null || true
            cp ~/htaccess_backup .htaccess 2>/dev/null || true
            cp ~/public_htaccess_backup public/.htaccess 2>/dev/null || true

            # Install composer dependencies
            echo "ðŸ“¥ Installing composer packages..."
            composer install --no-dev --optimize-autoloader --no-interaction

            # Build assets if npm is available
            if command -v npm &> /dev/null; then
              echo "ðŸ”¨ Building assets..."
              npm install && npm run build 2>/dev/null || true
            fi

            # Laravel commands
            echo "âš™ï¸ Running Laravel commands..."
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link 2>/dev/null || true

            # Set permissions
            chmod -R 755 storage bootstrap/cache

            echo "âœ… Deployment completed!"
